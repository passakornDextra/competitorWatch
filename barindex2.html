<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Competitor News</title>
  <style>
    :root {
      --bg: #f8fafc;
      --card: #ffffff;
      --ink: #0f172a;
      --ink-light: #334155;
      --ink-lighter: #64748b;
      --brand: #00a99d;
      --brand-dark: #008a81;
      --brand-light: #e6f7f6;
      --border: #e2e8f0;
      --border-light: #f1f5f9;
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      --shadow-xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
      --max: 1280px;
      --radius: 12px;
      --radius-lg: 16px;
    }
    
  
  

    * { box-sizing: border-box; }
    
    html, body { 
      height: 100%; 
      margin: 0; 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
      color: var(--ink); 
      background: var(--bg); 
      scroll-behavior: smooth;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      font-size: 16px;
    }

   
    .wrap { 
      max-width: var(--max); 
      margin: 0 auto; 
      padding: 32px 24px;
    }
#line {
  display: none !important;
}
#source {
  display: none !important;
}
    
header {
  background: #04cc9e; /* Solid Stribe green */
  color: #fff;
  box-shadow: var(--shadow-md);
  position: sticky;
  top: 0;
  z-index: 100;
  min-height: 72px; /* Adjust for your preferred bar height */
  display: flex;
  align-items: center;      /* Vertically center everything in the bar */
}


header .wrap {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 8px 16px; /* Less green space */
  gap: 12px;
  flex-wrap: wrap; /* Wrap on small screens */
}


.brand-vertical {
  display: flex;
  flex-direction: row;
  align-items: center;      /* Vertically center logo and text */
  gap: 20px;                /* Space between logo and text */
}

.logo {
  width: 100px; /* ‚Üì Smaller logo */
  aspect-ratio: 4/3;
  display: flex;
  align-items: center;
  justify-content: center;
  background: #fff;
  border-radius: 8px;
  margin: 0;
  padding: 0;
  box-shadow: none;
  border: none;
}

.logo img {
  width: 100%;
  height: 90%;
  object-fit: contain;
  padding: 0;
}

.brand-vertical h1 {
  font-size: 2em;
  font-weight: 700;
  margin: 0;
  padding: 0;
  color: #fff;
  background: none;
  line-height: 1;
  display: flex;
  align-items: center; /* Vertically center text with logo */
}

    

    h1 { 
      margin: 0; 
      font-size: 36px; 
      font-weight: 700; 
      letter-spacing: -0.5px; 
      color: #fff;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .controls { 
      display: flex;
      gap: 8px;
    }

    .control { position: relative; }
    

.controls .control select,
.controls .control input {
  padding: 6px 8px; /* Smaller boxes */
  font-size: 14px;
  border-radius: 6px;
  width: auto; /* No full width */
}


    .control select:hover,
    .control input:hover {
      border-color: rgba(255, 255, 255, 0.6);
      transform: translateY(-1px);
      box-shadow: var(--shadow);
    }
    
    .control select:focus, 
    .control input:focus { 
      border-color: #fff;
      background: #fff;
      box-shadow: 0 0 0 4px rgba(255, 255, 255, 0.25), var(--shadow);
      transform: translateY(-1px);
    }

    main.wrap { padding-top: 40px; padding-bottom: 80px; }

    .article-count {
      display: flex; justify-content: center; align-items: center;
      margin: 0 0 32px;
      font-size: 17px; font-weight: 600; color: var(--ink-light);
      padding: 14px 28px; background: var(--card); border-radius: var(--radius);
      box-shadow: var(--shadow-sm); border: 1px solid var(--border);
    }
    

    .grid { 
      display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
      gap: 24px; margin-top: 32px;
    }

    .card { 
      background: var(--card);
      box-shadow: var(--shadow); border: 1px solid var(--border-light);
      overflow: hidden; display: flex; flex-direction: column;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      animation: fadeIn 0.4s ease; height: 100%;
    }
    
    .card:hover { transform: translateY(-6px); box-shadow: var(--shadow-lg); border-color: var(--border); }
    
    .thumb { width: 100%; aspect-ratio: 16/9; background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%); object-fit: cover; transition: transform 0.3s ease; }
    .card:hover .thumb { transform: scale(1.05); }
    
    .pad { padding: 24px 28px; flex: 1; display: flex; flex-direction: column; }

    .title { font-weight: 700; font-size: 20px; line-height: 1.4; margin: 0 0 14px; color: var(--ink);
      display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    
    .summary { color: var(--ink-lighter); font-size: 16px; line-height: 1.6;
      display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden;
      margin-bottom: 18px; flex: 1; }
    
    .meta { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; margin: 0 0 18px; font-size: 15px;
      color: var(--ink-lighter); padding-bottom: 18px; border-bottom: 1px solid var(--border-light); }
    
    .meta .chip { background: var(--brand-light); color: var(--brand-dark); padding: 8px 14px; border-radius: 8px; font-weight: 600; font-size: 14px; letter-spacing: 0.3px; transition: all 0.2s ease; }
    .meta .chip:hover { background: var(--brand); color: white; }
    .meta .chip.line { background: #eef2ff; color: #4f46e5; }
    .meta .chip.line:hover { background: #4f46e5; color: white; }

    .actions { display: flex; gap: 12px; padding: 0 28px 24px; }
    .link { flex: 1; text-align: center; text-decoration: none; padding: 14px 18px; border-radius: var(--radius); border: 2px solid var(--border); background: #fff; font-weight: 600; font-size: 16px; color: var(--ink-light); transition: all 0.2s ease; display: inline-flex; align-items: center; justify-content: center; gap: 6px; }
    .link:hover { border-color: var(--ink-light); background: var(--ink-light); color: white; transform: translateY(-1px); box-shadow: var(--shadow); }

/* Primary button: modern, bold */
.link.primary {
  background: var(--brand);
  color: #fff;
  border: none;
  border-radius: 8px;
  padding: 12px 16px;
  font-size: 15px;
  font-weight: 600;
  transition: background 0.3s ease, transform 0.2s ease;
}
.link.primary:hover {
  background: var(--brand-dark);
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
}

/* Secondary button: softer look */
.link.secondary {
  background: var(--brand-light);
  color: var(--brand-dark);
  border: none;
  border-radius: 8px;
  padding: 12px 16px;
  font-size: 15px;
  font-weight: 500;
  transition: background 0.3s ease, transform 0.2s ease;
}
.link.secondary:hover {
  background: var(--brand);
  color: #fff;
  transform: translateY(-2px);
  box-shadow: var(--shadow);
}

    .empty, #status { background: var(--card); border: 2px dashed var(--border); padding: 48px 32px; border-radius: var(--radius-lg); text-align: center; color: var(--ink-lighter); margin-top: 32px; font-size: 18px; font-weight: 500; }

    .pager { display: flex; justify-content: center; align-items: center; margin: 48px 0 24px; gap: 16px; }
    .btn { padding: 14px 28px; border-radius: var(--radius); border: 2px solid var(--border); background: var(--card); cursor: pointer; font-weight: 600; font-size: 16px; color: var(--ink-light); transition: all 0.2s ease; box-shadow: var(--shadow-sm); }
    .btn:hover:not(:disabled) { border-color: var(--brand); background: var(--brand); color: white; transform: translateY(-1px); box-shadow: var(--shadow); }
    .btn:disabled { opacity: 0.4; cursor: not-allowed; background: var(--border-light); }
    #pageInfo { font-weight: 600; color: var(--ink-light); min-width: 140px; text-align: center; font-size: 17px; }

    #backToTop { position: fixed; bottom: 32px; right: 32px; background: var(--brand); color: white; border: none; padding: 18px 24px; border-radius: var(--radius); cursor: pointer; display: none; box-shadow: var(--shadow-lg); font-weight: 700; font-size: 18px; transition: all 0.3s ease; z-index: 50; }
    #backToTop:hover { background: var(--brand-dark); transform: translateY(-4px); box-shadow: var(--shadow-xl); }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

    @media (max-width: 768px) {
      h1 { font-size: 30px; }
      .logo { width: 200px; }
      .controls { grid-template-columns: 1fr; }
      .grid { grid-template-columns: 1fr; gap: 20px; }
      .wrap { padding: 24px 16px; }
      header .wrap { padding: 32px 16px 24px; }
      .title { font-size: 18px; }
      .summary { font-size: 15px; }
      .control select, .control input { font-size: 16px; }
      #backToTop { bottom: 20px; right: 20px; padding: 16px 20px; font-size: 16px; }
    }

    @media (max-width: 480px) {
      h1 { font-size: 26px; }
      .title { font-size: 17px; }
      .summary { font-size: 14px; }
      .actions { flex-direction: column; }
      .link { width: 100%; }
    }
    
/* --- UNHIDE the dropdowns + search (your CSS currently hides them globally) --- */
header .controls select,
header .controls input[type="text"] {
  display: inline-block !important;
}

/* --- Put title + filters on the SAME LINE --- */
header .wrap {
  display: flex !important;
  align-items: center !important;         /* vertical centering */
  justify-content: space-between !important; /* title left, filters right */
  gap: 12px !important;
  padding: 8px 16px !important;           /* trims the green bar height */
}

/* Title block stays compact on the left */
header .brand-vertical {
  display: flex !important;
  flex-direction: row !important;
  align-items: center !important;
  gap: 12px !important;
  margin: 0 !important;
}

/* Optional compact logo/title */
header .logo {
  width: 80px !important;
  aspect-ratio: 16/9;
  display: grid;
  place-items: center;
}
header .logo img {
  width: 100%;
  height: 100%;
  object-fit: contain;
}
header .brand-vertical h1 {
  margin: 0 !important;
  font-size: 20px !important;
  line-height: 1.2 !important;
}

/* --- Filters: one line on the RIGHT --- */
header .controls {
  display: flex !important;               /* change from grid ‚Üí flex */
  align-items: center !important;
  gap: 8px !important;
  margin: 0 !important;                   /* remove the top margin that pushes it below the title */
  flex-wrap: nowrap !important;           /* keep them in one row */
}

/* Make each control box smaller and not full-width */
header .controls .control {
  display: inline-flex !important;
}
header .controls .control select,
header .controls .control input[type="text"] {
  width: auto !important;                 /* prevent 100% width */
  padding: 6px 10px !important;           /* smaller boxes */
  font-size: 14px !important;
  border-radius: 6px !important;
}

/* Optional: hard cap header height if your theme is still tall */
header {
  min-height: 56px !important;            /* lower green bar height */
}



/* === BBC-style rail (Left ‚Ä¢ Center/Lead ‚Ä¢ Right) === */

.bbc-rail {
  background: linear-gradient(135deg, #e6f7f6 0%, #ffffff 100%);
  border-radius: 12px;
  padding: 24px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
}



/* Featured News heading with accent bar and fixed spacing */
main.wrap h2 {
  font-size: 1.8rem;
  font-weight: 700;
  color: #0f172a;
  border-left: 6px solid #00a99d; /* Dextra green accent */
  padding-left: 12px;
  margin: 0; /* Remove default margin */
  line-height: 1.2;
}

/* Tighten section spacing */
main.wrap {
  padding-top: 16px; /* Adjust as needed */
}

.bbc-rail {
  margin-top: 16px; /* Reduce gap between heading and cards */
}



/* Remove any bar from card titles */
.card .title {
  font-size: 16px !important; /* Previously 20px */;
  border-left: none !important;
  padding-left: 0 !important;
  margin: 0 0 12px;
}


/* Reuse your .card but size text differently for lead vs side */
.card--lead .title { font-size: 26px; line-height: 1.3; }
.card--lead .summary { -webkit-line-clamp: 4; }
.card--side .title { font-size: 18px; }
.card--side .summary { -webkit-line-clamp: 2; }

/* Make lead image feel more ‚Äúhero‚Äù */
.card--lead .thumb { aspect-ratio: 16/9; object-fit: cover; }

/* Responsive behavior */
@media (max-width: 1100px) {
  .bbc-rail { grid-template-columns: 1fr; }
  .rail-center { order: 1; }
  .rail-left { order: 2; }
  .rail-right { order: 3; }
}

/* BBC-style rail with stacked side stories */
.bbc-rail {
  display: grid;
  grid-template-columns: 1fr minmax(0, 1.6fr) 1fr; /* center is wider */
  gap: 24px;
  margin-top: 24px;
}

/* Left and right columns stack their cards */
.rail-left,
.rail-right {
  display: flex;
  flex-direction: column;
  gap: 16px; /* space between stacked stories */
}

/* Lead story in center */
.card--lead .title {
  font-size: 26px;
  line-height: 1.3;
}
.card--lead .summary {
  -webkit-line-clamp: 2;
}

/* Side stories smaller */
.card--side .title {
  font-size: 18px;
}
.card--side .summary {
  -webkit-line-clamp: 2;
}

/* Responsive: stack everything on small screens */
@media (max-width: 1100px) {
  .bbc-rail {
    grid-template-columns: 1fr;
  }
  .rail-center { order: 1; }
  .rail-left { order: 2; }
  .rail-right { order: 3; }
}


/* === Clean BBC rail layout (center hero, stacked sides) === */
.bbc-rail {
  display: grid;
  grid-template-columns: 1fr minmax(0, 2fr) 1fr; /* center is wider */
  gap: 20px;
  margin-top: 20px;
  align-items: stretch;
}

/* Side columns: use grid so both cards stretch evenly */
.rail-left,
.rail-right {
  display: grid;
  grid-auto-rows: 1fr;  /* each side card fills available row height */
  gap: 16px;
}

/* Make card layout robust and equal-height */
.card {
  height: 100%;
  display: flex;
  flex-direction: column;
}
.card .thumb {
  width: 100%;
  display: block;
  background: #eef2f7;
  object-fit: cover;
}

/* Hero (center) visuals */
.card--lead .thumb { height: 480px; }
.card--lead .title { font-size: 24px; line-height: 1.3; }
.card--lead .summary { display: -webkit-box; -webkit-line-clamp: ; -webkit-box-orient: vertical; overflow: hidden; }

/* Side (left/right) visuals: compact and clean */
.card--side .thumb { height: 140px; }
.card--side .title { font-size: 17px; line-height: 1.35; }
.card--side .summary { display: none; } /* keep side cards tight */
.card--side .actions { display: none; } /* hide buttons on side cards to reduce noise */
.card--side .meta { padding-bottom: 10px; }

/* Optional: tone down chip density on side cards */
.card--side .meta .chip.line { display: none; }

/* Grid for the rest: keep your existing grid but reduce top margin */
.grid { margin-top: 20px; }

/* Responsive: collapse to one column on smaller screens */
@media (max-width: 1100px) {
  .bbc-rail { grid-template-columns: 1fr; }
  .rail-center { order: 1; }
  .rail-left   { order: 2; }
  .rail-right  { order: 3; }
  .card--lead .thumb { height: 220px; }
}
 
.brand-vertical .logo {
  background: transparent;
  padding: 0;
  margin: 0;
}

.card--side .actions {
  display: flex !important; /* or inline-flex */
  gap: 8px;
  padding: 0 5px 5px;
}


.card--side {
  height: auto; /* Let content define height */
  display: flex;
  flex-direction: column;
  padding-bottom: 12px; /* Slight breathing room */
}


.pad {
  padding-bottom: 0 !important; /* Remove bottom padding */
}

.actions {
  padding-top: 0 !important; /* Remove top padding */
  margin-top: 0 !important;  /* Kill any margin */
}

.card {
  display: flex;
  flex-direction: column;
}


.pad {
  padding-bottom: 8px !important; /* Reduce from 24px */
}

.actions {
  padding-top: 0 !important; /* Remove top padding */
  padding-bottom: 16px !important; /* Keep bottom breathing room */
  margin-top: 0 !important;
}

.actions .link {
  padding: 10px 14px !important;
  font-size: 14px !important;
}

/* Reduce padding inside the main content area */
.card--lead .pad {
  padding-bottom: 8px !important; /* was 24px */
}

/* Remove extra gap above buttons */
.card--lead .actions {
  padding-top: 0 !important;
  margin-top: 0 !important;
}



.card--lead {
  height: 80% !important; /* Only the center card */
  display: flex;
  flex-direction: column;
}


.card--lead .pad {
  flex: 1; /* Push content up */
}

.card--lead .actions {
  margin-top: auto; /* Buttons at bottom */
}

.card--side .title {
  font-size: 16px !important; /* Reduce from 18px */
  line-height: 1.3;
  margin-bottom: 6px;
}

.card--side .meta {
  font-size: 13px !important; /* Slightly smaller for tags/date */
}

.card--side .actions .link {
  font-size: 14px !important; /* Buttons smaller for balance */
}


/* Make the hero image taller */

.card--lead .thumb {
  height: 280px !important; /* Smaller hero image */
  object-fit: cover; /* Keeps aspect ratio clean */
}


/* Make the title stand out */

.card--lead .title {
  font-size: 28px !important; /* Reduce from 36px */
}


/* Optional: enlarge summary slightly */
.card--lead .summary {
  font-size: 17px !important;
  line-height: 1.6;
}


/* Remove bottom padding from .pad */
.pad {
  padding-bottom: 0 !important;
}

/* Optional: tighten top padding too */
.pad {
  padding-top: 16px !important; /* or keep original if needed */
}

/* Ensure buttons stay aligned */
.actions {
  padding-top: 0 !important;
  margin-top: 0 !important;
}


/* Upload button styling */




/* Position it on the far right */
header .wrap {
  justify-content: space-between;
}

header .wrap .btn-upload {
  margin-left: auto; /* Push to far right */
}

.btn-upload:active {
  transform: translateY(0);
  box-shadow: var(--shadow-sm);
}


header .wrap {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
  flex-wrap: nowrap; /* Prevent wrapping */
  overflow-x: auto;  /* Allow horizontal scroll if too tight */
}

header .controls {
  display: flex;
  align-items: center;
  gap: 8px;
  flex-wrap: nowrap; /* Keep all controls in one line */
}

header .controls select,
header .controls input[type="text"],
header .controls button {
  background: #fff; /* Pure white */
  border: 1px solid #ccc;
  color: #0f172a;
  padding: 6px 10px;
  font-size: 14px;
  border-radius: 6px;
  flex-shrink: 0; /* Prevent shrinking too much */
}



.btn-upload {
  background-color: #374151 !important; /* Gray idle */
  color: #fff !important;
  border: none;
  border-radius: 6px;
  padding: 10px 16px;
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
  transition: all 0.3s ease;
}

.btn-upload:hover {
  background-color: #0048b6  !important; /* Brand green hover */
  transform: scale(1.05);
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}




.bbc-rail {
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}

.bbc-rail {
  background: linear-gradient(135deg, #e6f7f6 0%, #ffffff 100%);
}


.card .thumb {
  border-top-left-radius: 0 !important;
  border-top-right-radius: 0 !important;
}


.card .summary {
  display: none !important; /* Hides the summary text */
}

.card .pad {
  padding-bottom: 8 !important; /* Remove extra space reserved for summary */
}


.card .meta {
  border-bottom: none !important; /* Remove the horizontal line */
  padding-bottom: 8px !important; /* Reduce extra space */
}


.card .actions {
  margin-top: 2px !important; /* Move buttons closer */
}


#brandImg {
  background: #fff;            /* White background */
  border-radius: 0px;         /* Rounded corners */
  box-shadow: var(--shadow-sm);/* Optional subtle shadow */
  display: inline-block;       /* Ensure padding works */
  
}

#brandImg1 {
  transform: scaleX(-1);       /* Flip left-right */
  transform-origin: center;    /* Keep flip centered */
}
.card .thumb {
  object-fit: contain !important;
  background: #fff; /* optional: makes logos look better */
}




  </style>

</head>
<body>

<header>
    


  <div class="wrap">
    <div class="brand-vertical">
      <div class="logo" title="Brand"><img id="brandImg" alt="Brand"></div>
      <h1>Competitor News - Bar System</h1>
    </div>
    <div class="controls">
       <div class="brand-vertical" style="text-align:center;">
              <div class="logo" title="Brand">
                <img id="brandImg1" src="https://raw.githubusercontent.com/passakornDextra/competitorWatch/main/logos/2.%20BAR.png" alt="Brand Logo" style="max-width:150px;">

            </div>
      
      <div class="control"><select id="line"><option value="">All Product Lines</option><option value="CRP">CRP</option><option value="Bars">Bars</option><option value="Geotec">Geotec</option></select></div>
      <div class="control"><select id="source"><option value="">All Companies</option></select></div>
      <div class="control"><input type="text" id="search" placeholder="üîç Search keyword..." /></div>
      <div class="control">
        <select id="sort">
          <option value="date_desc">üìÖ Newest First</option>
          <option value="date_asc">üìÖ Oldest First</option>
          <option value="title_asc">üî§ Title A‚ÄìZ</option>
          <option value="title_desc">üî§ Title Z‚ÄìA</option>
        </select>
      </div>
       
           



    </div>
    
  </div>
</header>

<main class="wrap">
  <div id="status" class="empty">Loading articles‚Ä¶</div>
  <div class="article-count" id="articleCount" hidden></div>
  <section id="rail" class="bbc-rail" hidden>
  <div class="rail-left"></div>
  <div class="rail-center"></div>
  <div class="rail-right"></div>
</section>

  <section id="grid" class="grid" hidden></section>
  <nav id="pager" class="pager" hidden>
    <button class="btn" id="prev">‚Üê Previous</button>
    <span id="pageInfo" class="muted"></span>
    <button class="btn" id="next">Next ‚Üí</button>
  </nav>
</main>

<button id="backToTop" onclick="window.scrollTo({ top: 0, behavior: 'smooth' });">‚Üë Top</button>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script>
  const byId = id => document.getElementById(id);
  const el = (tag, cls) => { const e=document.createElement(tag); if(cls) e.className=cls; return e; }

  const STATE = { raw:[], filtered:[], page:1, pageSize:12, sort:'date_desc', source:'', search:'', line:'' };

  const LOGO_BASE = "https://raw.githubusercontent.com/passakornDextra/competitorWatch/main/logos/";
  const LOGO_DEFAULT = LOGO_BASE + "0 Logo Dextra RGB Web Colors.png";

  const LINE_LOGOS = {
    "crp": LOGO_BASE + "CRP_16x9_white.png",
    "bars": LOGO_BASE + "Bars_16x9_white.png",
    "geotec": LOGO_BASE + "Geo_16x9_white.png"
  };

  const normalize = s => (s || "")
    .toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
    .replace(/[\u2018\u2019]/g, "'")
    .replace(/[\u2013\u2014]/g, "-")
    .replace(/[^a-z0-9]+/g, " ")
    .replace(/\s+/g, " ").trim();

  const LOGO_MAP = {
    "dywidag": "DYWIDAG_16x9.png",
    "anker schroeder": "Anker_Schroeder_16x9.png",
    "ancon": "Leviat_Ancon_16x9.png",
    "stahlwerk annahutte": "SAH_Stahlwerk_Annahutte_16x9.png",
    "sah": "SAH_Stahlwerk_Annahutte_16x9.png",
    "nvent lenton": "nVent_Lenton_16x9.png",
    "lenton": "nVent_Lenton_16x9.png",
    "macalloy": "Macalloy_16x9.png",
    "moment": "Leviat_Moment_16x9.png",
    "firep minova": "FiReP_16x9.png",
    "williams form": "Williams_Form_16x9.png",
    "splice sleeve": "Splice_Sleeve_16x9.png",
    "boowon bms": "Boowon_BMS_16x9.png",
    "mateenbar": "Mateenbar_16x9.png",
    "mst bar": "MST_Bar_16x9.png",
    "mateenbar pultron" : "Mateenbar_16x9.png",
    "nmb splice sleeve" : "NMB_Splice_Sleeve_16x9.png"
  };

  /* --- Aliases coming from CSV (normalize to canonical) --- */
  const LOGO_ALIASES = {
    "williams": "williams form",
    "williams form engineering": "williams form",
    "williams form engineering corp": "williams form",
    "william form": "williams form",
    "moment (leviat)": "moment",
    "leviat moment": "moment",
    "moment-leviat": "moment",
    "moment leviat": "moment",
    "ancon (leviat)": "ancon",
    "minova apac": "firep minova",
    "firep": "firep minova",
    "fi rep": "firep minova",
    "fi rep minova": "firep minova",
    "mstbar": "mst bar",
    "mst-bar": "mst bar",
    "sah annahutte": "stahlwerk annahutte",
    "stahlwerk annahuette": "stahlwerk annahutte"
  };

  /* --- Product lines per canonical source --- */
  const LINE_MAP = {
    "moment": ["CRP"],
    "ancon": ["CRP"],
    "nvent lenton": ["CRP"],
    "nmb splice sleeve": ["CRP"],
    "boowon bms": ["CRP"],
    "dywidag": ["Bars", "Geotec"],
    "anker schroeder": ["Bars"],
    "macalloy": ["Bars"],
    "williams form": ["Bars"],
    "stahlwerk annahutte": ["Bars", "Geotec"],
    "sah": ["Bars", "Geotec"],
    "mateenbar": ["Geotec"],
    "mst bar": ["Geotec"],
    "firep minova": ["Geotec"],
    "mateenbar pultron" : ["Geotec"]
    
  };

  /* --- Display name mapping (what the user sees) --- */
  const DISPLAY_NAME = {
    "moment": "Moment (Leviat)",
    "ancon": "Ancon (Leviat)",
    "nvent lenton": "nVent LENTON",
    "firep minova": "FiReP Minova",
    "dywidag": "DYWIDAG",
    "anker schroeder": "Anker Schroeder",
    "stahlwerk annahutte": "Stahlwerk Annah√ºtte",
    "sah": "Stahlwerk Annah√ºtte",
    "macalloy": "Macalloy",
    "williams form": "Williams Form",
    "nmb splice sleeve": "NMB Splice Sleeve",
    "mateenbar": "Mateenbar",
    "mst bar": "MST Bar",
    "boowon bms": "Boowon BMS",
    "mateenbar pultron": "Mateenbar (Pultron)"
  };
  function displayFor(canon) {
    if (!canon) return '';
    if (DISPLAY_NAME[canon]) return DISPLAY_NAME[canon];
    return canon.replace(/\b\w/g, c => c.toUpperCase());
  }

  function logoFileFor(canonical) {
    if (LOGO_MAP[canonical]) return LOGO_MAP[canonical];
    let bestKey = null;
    for (const k in LOGO_MAP) {
      if (canonical.includes(k)) { if (!bestKey || k.length > bestKey.length) bestKey = k; }
    }
    return bestKey ? LOGO_MAP[bestKey] : null;
  }

  function canonicalFor(name) {
    const key = normalize(name);
    return LOGO_ALIASES[key] || key;
  }

  function logoSrcFor(nameOrCanon) {
    const canonical = canonicalFor(nameOrCanon);
    const file = logoFileFor(canonical);
    return file ? (LOGO_BASE + file) : null;
  }

  function linesFor(name) {
    const canonical = canonicalFor(name);
    return LINE_MAP[canonical] || [];
  }

  function setHeaderLogo() {
    const img = byId("brandImg");
    const companyLogo = STATE.source && logoSrcFor(STATE.source); // STATE.source is canonical
    const lineKey = (STATE.line || '').toLowerCase();
    const lineSrc = LINE_LOGOS[lineKey];
    const src = companyLogo || lineSrc || LOGO_DEFAULT;

    img.hidden = false;
    img.alt = companyLogo ? displayFor(STATE.source) : (STATE.line || 'Dextra');
    img.src = src;
    img.onerror = () => { img.onerror = null; img.src = LOGO_DEFAULT; };
  }

  function parseDate(v) {
    if (!v) return null;
    const d = new Date(v);
    if (!isNaN(d)) return d;
    const m = String(v).match(/(\d{1,2})[\/.\-](\d{1,2})[\/.\-](\d{2,4})/);
    if (m) {
      const [_, d1, m1, y1] = m;
      const yr = y1.length === 2 ? (Number(y1) + 2000) : Number(y1);
      return new Date(yr, Number(m1) - 1, Number(d1));
    }
    return null;
  }

  function loadCSV() {
    Papa.parse('export_combined.csv', {
      download: true, header: true, skipEmptyLines: true,
      complete: (res) => {
        const rows = res.data.map(r => {
          const srcRaw   = r.Source?.trim() || '';
          const srcCanon = canonicalFor(srcRaw);

          // Normalize ISO date (prefer CSV DateISO; fallback to parsed Date/DateText)
          const isoCSV = (r.DateISO || '').trim().slice(0, 10); // YYYY-MM-DD
          const fallbackObj = parseDate(r.Date || r.DateText);
          const isoFallback = fallbackObj ? fallbackObj.toISOString().slice(0,10) : '';
          const dateISO = isoCSV || isoFallback;

          // Robust numeric sort key; blank ‚Üí 0 (goes to bottom on DESC)
          const dateKeyNum = dateISO ? Number(dateISO.replace(/-/g, '')) : 0;

          return {
            Title: r.Title?.trim() || '',
            DateText: r.DateText?.trim() || '',
            DateISO: dateISO,
            DateObj: fallbackObj || null,
            DateKeyNum: dateKeyNum,
            Link: r.Link?.trim() || '',
            Image: r.Image?.trim() || '',
            Summary: r.Summary?.trim() || '',
            Source: srcRaw,                      // original
            SourceCanon: srcCanon,               // normalized key
            SourceDisplay: displayFor(srcCanon), // pretty label
            Lines: linesFor(srcRaw)
          };
        });

        STATE.raw = rows;
        hydrateSources(rows);

        const params = new URLSearchParams(location.search);
        const preCompany = params.get('company');
        const preLine = params.get('line');
        const preSearch = params.get('search');
        const preSort = params.get('sort');
        
        if (preCompany) {
          const cand = canonicalFor(preCompany);
          if ([...byId('source').options].some(o => o.value === cand)) {
            byId('source').value = cand;
            STATE.source = cand;
          }
        }
        if (preLine && ["CRP","Bars","Geotec"].includes(preLine)) {
          byId('line').value = preLine;
          STATE.line = preLine;
        }
        if (preSearch) {
          byId('search').value = preSearch;
          STATE.search = preSearch;
        }
        if (preSort && ['date_desc', 'date_asc', 'title_asc', 'title_desc'].includes(preSort)) {
          byId('sort').value = preSort;
          STATE.sort = preSort;
        }

        setHeaderLogo();
        applyFilters();
      },
      error: () => { byId('status').textContent = 'Could not load export_combined.csv.'; }
    });
  }

  /* Populate dropdown using canonical values but display nice names */
  function hydrateSources(rows) {
    const sel = byId('source');
    const uniqCanon = [...new Set(rows.map(r => r.SourceCanon).filter(Boolean))]
      .sort((a,b) => displayFor(a).localeCompare(displayFor(b)));
    uniqCanon.forEach(canon => {
      const o = el('option');
      o.value = canon;                   // filter by canonical
      o.textContent = displayFor(canon); // label users see
      sel.appendChild(o);
    });
  }

  function applyFilters() {
    const { source, sort, search, line } = STATE;
    let rows = STATE.raw.filter(r =>
      (!source || r.SourceCanon === source) &&
      (!line || (r.Lines && r.Lines.includes(line))) &&
      (!search || r.Title.toLowerCase().includes(search.toLowerCase()) || r.Summary.toLowerCase().includes(search.toLowerCase()))
    );

    rows.sort((a, b) => {
      switch (sort) {
        case 'title_asc':  return a.Title.localeCompare(b.Title);
        case 'title_desc': return b.Title.localeCompare(a.Title);
        case 'date_asc':
          return (a.DateKeyNum - b.DateKeyNum) ||
                 a.Title.localeCompare(b.Title);
        default: // date_desc
          return (b.DateKeyNum - a.DateKeyNum) ||
                 a.Title.localeCompare(b.Title);
      }
    });

    STATE.filtered = rows;
    STATE.page = 1;
    render();
  }

 

function render() {
  const grid = byId('grid');
  const rail = byId('rail');
  const status = byId('status');
  const pager = byId('pager');
  const count = byId('articleCount');

  const rows = STATE.filtered || [];
  const total = rows.length;

  // No results
  if (!total) {
    rail.hidden = true;
    grid.hidden = true;
    pager.hidden = true;
    count.hidden = true;
    status.hidden = false;
    status.textContent = 'No articles found.';
    return;
  }

  status.hidden = true;
  count.hidden = false;

  // Prepare top 5: center (1), left (2), right (2)
  const center = rows[0] || null;
  const leftStories  = rows.slice(1, 3);
  const rightStories = rows.slice(3, 5);

  // Render rail
  rail.hidden = false;
  const railLeft   = rail.querySelector('.rail-left');
  const railCenter = rail.querySelector('.rail-center');
  const railRight  = rail.querySelector('.rail-right');

  railLeft.innerHTML = '';
  railCenter.innerHTML = '';
  railRight.innerHTML = '';

  if (center)    railCenter.appendChild(card(center, 'lead'));
  leftStories.forEach(s  => railLeft.appendChild(card(s, 'side')));
  rightStories.forEach(s => railRight.appendChild(card(s, 'side')));

  // Render rest in grid with pagination
  const rest = rows.slice(5);
  grid.innerHTML = '';

  if (rest.length === 0) {
    grid.hidden = true;
    pager.hidden = true;
    count.textContent = `Showing ${Math.min(5, total)} of ${total} articles`;
    return;
  }

  grid.hidden = false;
  pager.hidden = false;

  const totalPages = Math.max(1, Math.ceil(rest.length / STATE.pageSize));
  if (STATE.page > totalPages) STATE.page = totalPages;

  const start = (STATE.page - 1) * STATE.pageSize;
  const end = start + STATE.pageSize;
  const pageRows = rest.slice(start, end);

  pageRows.forEach(r => grid.appendChild(card(r)));

  byId('pageInfo').textContent = `Page ${STATE.page} / ${totalPages}`;
  byId('prev').disabled = STATE.page <= 1;
  byId('next').disabled = STATE.page >= totalPages;

  const shownFrom = 5 + start + 1;
  const shownTo   = 5 + start + pageRows.length;
  count.textContent = `Welcome to Competitor Watch!`;
}


  // Keep your existing prev/next listeners; they already call render().


  
function card(row, variant) {
  const c = el('article', 'card' + (variant ? ` card--${variant}` : ''));
  const img = el('img', 'thumb');
  img.loading = 'lazy';
  img.alt = row.Title || 'thumbnail';
  img.src = row.Image || 'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22400%22 height=%22225%22><rect width=%22400%22 height=%22225%22 fill=%22%23f1f5f9%22/><text x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 fill=%2394a3b8%22 font-size=%2218%22 font-family=%22system-ui%22 font-weight=%22600%22>No image available</text></svg>';
  img.onerror = () => {
    img.onerror = null;
    img.src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="400" height="225"><rect width="400" height="225" fill="%23f1f5f9"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="%2394a3b8" font-size="18" font-family="system-ui" font-weight="600">No image available</text></svg>';
  };
  c.appendChild(img);

  const p = el('div', 'pad');
  const h = el('h2', 'title'); h.textContent = row.Title || '(Untitled)';
  const meta = el('div', 'meta');

  const chip = el('span', 'chip');
  chip.textContent = row.SourceDisplay || 'Unknown';
  meta.append(chip);

  if (row.Lines && row.Lines.length) {
    row.Lines.forEach(L => {
      const ch = el('span', 'chip line'); ch.textContent = L; meta.append('‚Ä¢', ch);
    });
  }

  const date = el('span');
  date.textContent = row.DateISO || '';
  meta.append('‚Ä¢', date);

  const sum = el('p', 'summary'); sum.textContent = row.Summary || '';
  p.append(h, meta, sum);
  c.appendChild(p);

  const actions = el('div', 'actions');
  const a1 = el('a', 'link primary'); a1.href = row.Link || '#'; a1.target = '_blank'; a1.rel = 'noopener'; a1.textContent = 'Read Article';
  const a2 = el('a', 'link'); a2.href = `https://www.google.com/search?q=${encodeURIComponent((row.Title || '') + ' ' + (row.SourceDisplay || ''))}`; a2.target = '_blank'; a2.rel = 'noopener'; a2.textContent = 'Search More';
  actions.append(a1, a2);
  c.appendChild(actions);

  return c;
}

function filterCompaniesByLine(selectedLine) {
  const sel = byId('source');
  sel.innerHTML = ''; // Clear existing options

  // Always include "All Companies"
  const defaultOpt = el('option');
  defaultOpt.value = '';
  defaultOpt.textContent = 'All Companies';
  sel.appendChild(defaultOpt);

  // If no line selected, show all companies
  if (!selectedLine) {
    const uniqCanon = [...new Set(STATE.raw.map(r => r.SourceCanon).filter(Boolean))]
      .sort((a,b) => displayFor(a).localeCompare(displayFor(b)));
    uniqCanon.forEach(canon => {
      const o = el('option');
      o.value = canon;
      o.textContent = displayFor(canon);
      sel.appendChild(o);
    });
    return;
  }

  // Filter companies that have this line in LINE_MAP
  const uniqCanon = [...new Set(STATE.raw.map(r => r.SourceCanon).filter(Boolean))]
    .filter(canon => (LINE_MAP[canon] || []).includes(selectedLine))
    .sort((a,b) => displayFor(a).localeCompare(displayFor(b)));

  uniqCanon.forEach(canon => {
    const o = el('option');
    o.value = canon;
    o.textContent = displayFor(canon);
    sel.appendChild(o);
  });
}



const allowedLines = ["CRP", "Bars", "Geotec"];

byId('source').addEventListener('change', e => {
  STATE.source = e.target.value;
  setHeaderLogo();
  applyFilters();
});


byId('line').addEventListener('change', e => {
  STATE.line = e.target.value;
  filterCompaniesByLine(STATE.line); // Rebuild company dropdown
  setHeaderLogo();
  applyFilters();
});


byId('sort').addEventListener('change', e => {
  STATE.sort = e.target.value;
  applyFilters();
});

byId('search').addEventListener('input', e => {
  STATE.search = e.target.value;
  applyFilters();
});

byId('prev').addEventListener('click', () => {
  STATE.page = Math.max(1, STATE.page - 1);
  render();
  window.scrollTo({ top: 0, behavior: 'smooth' });
});

byId('next').addEventListener('click', () => {
  const totalPages = Math.max(1, Math.ceil(STATE.filtered.length / STATE.pageSize));
  STATE.page = Math.min(totalPages, STATE.page + 1);
  render();
  window.scrollTo({ top: 0, behavior: 'smooth' });
});

window.addEventListener('scroll', () => {
  const btn = byId('backToTop');
  btn.style.display = window.scrollY > 300 ? 'block' : 'none';
});


  setHeaderLogo();
  loadCSV();
</script>
</body>
</html>
